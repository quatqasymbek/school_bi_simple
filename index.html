<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–®–∫–æ–ª—å–Ω–∞—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (BI)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Styles -->
    <style>
        :root {
            --primary: #123b71;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text: #333;
            --border: #dde2e5;
            --accent: #3498db;
        }
        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        header {
            background: var(--primary);
            color: #fff;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        header h1 { font-size: 1.2rem; margin: 0; font-weight: 600; }

        /* Tabs */
        .tabs-bar {
            background: #1c4e8f;
            display: flex;
            overflow-x: auto;
            flex-shrink: 0;
        }
        .tab-link {
            padding: 12px 20px;
            color: #b0c4de;
            text-decoration: none;
            font-size: 0.9rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
            white-space: nowrap;
        }
        .tab-link:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .tab-link.active {
            color: #fff;
            border-bottom-color: #fff;
            font-weight: 500;
        }

        /* Main Layout */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Grids */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-1 { display: grid; grid-template-columns: 1fr; gap: 20px; }
        
        /* Responsive Grid */
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .card h3 { margin-top: 0; font-size: 1rem; color: #555; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;}

        /* Controls */
        .controls-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .controls-row label { font-weight: 500; font-size: 0.9rem; color: #555; margin-right: 5px; }
        select, button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover { background: #0e2a50; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* KPI Styling */
        .kpi-value { font-size: 2.5rem; font-weight: 700; color: var(--primary); }
        .kpi-label { font-size: 0.9rem; color: #777; margin-top: 5px; }

        /* AI Section */
        .ai-box {
            background: #eef2f6;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-top: 15px;
            font-size: 0.95rem;
            line-height: 1.5;
            min-height: 60px;
        }
        
        /* Data Tables */
        .table-responsive { overflow-x: auto; }
        table.data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        table.data-table th, table.data-table td {
            padding: 10px 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        table.data-table th {
            background: #f9f9f9;
            font-weight: 600;
            color: #555;
            text-align: left;
        }
        table.data-table td:first-child, table.data-table th:first-child {
            text-align: left;
            font-weight: 500;
        }
        .grade-bad { color: #e74c3c; font-weight: bold; }
        .grade-good { color: #2ecc71; font-weight: bold; }

        /* Utilities */
        #statusBar { font-size: 12px; color: #888; margin-right: 15px; }
        #log { display: none; } 

    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:10px;">
        <span>üìä</span>
        <h1>–®–∫–æ–ª—å–Ω–∞—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
    </div>
    <div style="display:flex; align-items:center;">
        <span id="statusBar">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏...</span>
    </div>
</header>

<div class="tabs-bar">
    <div class="tab-link active" data-page="overview">–û–±–∑–æ—Ä</div>
    <div class="tab-link" data-page="classes">–ö–ª–∞—Å—Å—ã</div>
    <div class="tab-link" data-page="subjects">–ü—Ä–µ–¥–º–µ—Ç—ã</div>
    <div class="tab-link" data-page="teachers">–£—á–∏—Ç–µ–ª—è</div>
    <div class="tab-link" data-page="attendance">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</div>
</div>

<main>
    <!-- PAGE 1: OVERVIEW -->
    <div id="overview" class="page active">
        <!-- Selectors -->
        <div class="controls-row">
            <div>
                <label>–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
                <select id="ovTermSelect"></select>
            </div>
            <div>
                <label>–ú–µ—Ç—Ä–∏–∫–∞:</label>
                <select id="ovMetricSelect">
                    <option value="quality">–ö–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π (%)</option>
                    <option value="average">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ (1-5)</option>
                </select>
            </div>
            <div style="margin-left: auto;">
                <button id="btn-overview-refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>

        <!-- KPIs -->
        <div class="grid-2">
            <div class="card" style="text-align: center;">
                <div class="kpi-value" id="ovKpiStudents">-</div>
                <div class="kpi-label">–í—Å–µ–≥–æ —É—á–∞—â–∏—Ö—Å—è</div>
            </div>
            <div class="card" style="text-align: center;">
                <div class="kpi-value" id="ovKpiTeachers">-</div>
                <div class="kpi-label">–í—Å–µ–≥–æ —É—á–∏—Ç–µ–ª–µ–π</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid-2">
            <!-- Donut -->
            <div class="card">
                <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ (–ø–æ –∏—Ç–æ–≥–∞–º —á–µ—Ç–≤–µ—Ä—Ç–∏)</h3>
                <div id="chart-overview-donut" style="height: 350px;"></div>
                <div style="font-size: 0.8rem; color:#666; margin-top:10px; text-align:center;">
                    –û—Ç–ª–∏—á–Ω–∏–∫–∏ (5) | –•–æ—Ä–æ—à–∏—Å—Ç—ã (4-5) | –¢—Ä–æ–µ—á–Ω–∏–∫–∏ (3) | –î–≤–æ–µ—á–Ω–∏–∫–∏ (2)
                </div>
            </div>

            <!-- Grades Bar -->
            <div class="card">
                <h3>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ø–∞—Ä–∞–ª–ª–µ–ª—è–º (1-11 –∫–ª–∞—Å—Å—ã)</h3>
                <div id="chart-overview-grades" style="height: 350px;"></div>
            </div>
        </div>

        <!-- AI Analysis -->
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>üß† AI –ê–Ω–∞–ª–∏—Ç–∏–∫</h3>
                <button id="btn-overview-ai">‚ú® –û–±—ä—è—Å–Ω–∏—Ç—å –æ–±—â–∏–π —Ç—Ä–µ–Ω–¥</button>
            </div>
            <div id="overview-ai-output" class="ai-box">
                –õ–æ–∫–∞–ª—å–Ω—ã–π –ò–ò –ø–æ–∫–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑.
            </div>
        </div>
    </div>

    <!-- PAGE 2: CLASSES -->
    <div id="classes" class="page">
        <!-- Block 1: Matrix Table -->
        <div class="card">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px; flex-wrap: wrap; gap: 10px;">
                <h3>–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ –∫–ª–∞—Å—Å–∞–º</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <label>–ê–∫—Ü–µ–Ω—Ç (—á–µ—Ç–≤–µ—Ä—Ç—å):</label>
                    <select id="clsTableTermSelect"></select>

                    <label>–ú–µ—Ç—Ä–∏–∫–∞:</label>
                    <select id="clsTableMetricSelect">
                        <option value="quality">–ö–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π (%)</option>
                        <option value="average">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</option>
                    </select>
                </div>
            </div>
            <div class="table-responsive">
                <table class="data-table" id="class-summary-table">
                    <thead>
                        <tr id="class-summary-header">
                            <th>–ö–ª–∞—Å—Å</th>
                            <th>–ö–ª. –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</th>
                            <!-- Term columns will be injected here via JS -->
                        </tr>
                    </thead>
                    <tbody id="class-summary-body">
                        <!-- Data rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Block 2: Detailed Donut -->
        <div class="grid-1">
            <div class="card">
                <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap;">
                    <h3>–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ –∫–ª–∞—Å—Å–∞</h3>
                    <div class="controls-row" style="margin-bottom:0; padding: 5px 10px; border:none;">
                        <label>–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
                        <select id="clsDonutTermSelect"></select>
                        
                        <label style="margin-left:10px;">–ö–ª–∞—Å—Å:</label>
                        <select id="clsDonutClassSelect"></select>
                    </div>
                </div>
                <div id="chart-class-donut" style="height:400px;"></div>
            </div>
        </div>
    </div>

    <!-- PAGE 3: SUBJECTS -->
    <div id="subjects" class="page">
        <div class="card">
            <h3>–ê–Ω–∞–ª–∏–∑ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h3>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤...</p>
            <!-- Integration point for dashboard_subject.js -->
            <div class="controls-row">
                <label>–ü—Ä–µ–¥–º–µ—Ç:</label>
                <select id="subjectSubjectSelect"></select>
                <label>–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
                <select id="subjectTermSelect"></select>
            </div>
            <div id="chart-subject-heatmap" style="height: 400px;"></div>
        </div>
    </div>

    <!-- PAGE 4: TEACHERS -->
    <div id="teachers" class="page">
        <div class="card">
            <h3>–ê–Ω–∞–ª–∏–∑ –ø–æ —É—á–∏—Ç–µ–ª—è–º</h3>
            <p>–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
        </div>
    </div>

    <!-- PAGE 5: ATTENDANCE -->
    <div id="attendance" class="page">
        <div class="card">
            <h3>–°–≤–æ–¥–∫–∞ –ø–æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</h3>
            <div class="controls-row">
                <label>–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
                <select id="attTermSummary"></select>
            </div>
            <!-- Wrapper for Attendance Summary Table -->
            <div id="attSummaryTableWrapper" class="table-responsive"></div>
        </div>
        
        <div class="card">
             <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–ª–∞—Å—Å–∞–º</h3>
             <div class="controls-row">
                <label>–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
                <select id="attTermDetail"></select>
                <label>–ö–ª–∞—Å—Å:</label>
                <select id="attClassDetail"></select>
            </div>
            <!-- Wrapper for Attendance Detail Table -->
            <div id="attDetailTableWrapper" class="table-responsive"></div>
        </div>
    </div>

</main>

<!-- 1. Libraries -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<!-- 2. App Utilities & Core -->
<script src="utils.js"></script>
<script src="main.js"></script>
<script src="llm_cpu.js"></script>

<!-- 3. Dashboard Modules -->
<script src="overview.js"></script>
<script src="overview_ai.js"></script>
<script src="attendance.js"></script>
<script src="dashboard_class.js"></script>
<script src="dashboard_subject.js"></script>

<!-- 4. UI Logic (Tab Switching) -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const links = document.querySelectorAll('.tab-link');
        const pages = document.querySelectorAll('.page');

        function activatePage(pageId) {
            // 1. Update Pages
            pages.forEach(p => p.classList.remove('active'));
            const activePage = document.getElementById(pageId);
            if (activePage) activePage.classList.add('active');

            // 2. Update Tabs
            links.forEach(l => l.classList.remove('active'));
            const activeLink = document.querySelector(`.tab-link[data-page="${pageId}"]`);
            if (activeLink) activeLink.classList.add('active');
            
            // Optional: Trigger resize for Plotly charts when tab becomes visible
            if (typeof Plotly !== 'undefined') {
                setTimeout(() => {
                    document.querySelectorAll('.js-plotly-plot').forEach(el => {
                        Plotly.Plots.resize(el);
                    });
                }, 100);
            }
        }

        links.forEach(link => {
            link.addEventListener('click', (e) => {
                const pageId = link.dataset.page;
                activatePage(pageId);
            });
        });
    });
</script>

</body>
</html>
