<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>School BI Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f7f6;
            --white: #ffffff;
            --text: #333;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        * { box-sizing: border-box; }

        header {
            background: var(--primary);
            color: white;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .btn-upload {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        .btn-upload:hover {
            background: #219150;
        }

        .tabs {
            background: white;
            display: flex;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
            flex-shrink: 0;
        }

        .tab-btn {
            padding: 15px 20px;
            border: none;
            background: none;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-btn:hover {
            background: #f9f9f9;
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .page { display: none; }
        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #eee;
        }

        .kpi-val {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }

        .kpi-lbl {
            font-size: 0.85rem;
            color: #777;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 10px;
            border: 1px solid #eee;
            text-align: center;
        }

        th {
            background: #f8f9fa;
            color: #444;
        }

        .grade-5 { color: #27ae60; font-weight: bold; }
        .grade-4 { color: #2980b9; font-weight: bold; }
        .grade-3 { color: #f39c12; font-weight: bold; }
        .grade-2 { color: #c0392b; font-weight: bold; }

        .filters {
            background: #eef2f7;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        select, button.action-btn {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button.action-btn {
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
        }

        button.action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #status-log {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #222;
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            padding: 5px 10px;
            height: 30px;
            overflow: hidden;
            white-space: nowrap;
        }

        .ai-out {
            white-space: pre-wrap;
            font-size: 0.95rem;
            line-height: 1.35;
        }
    </style>
</head>
<body>

<header>
    <h3>üéì School BI Platform</h3>
    <div>
        <input type="file" id="xlsxInput" accept=".xlsx" style="display:none">
        <button class="btn-upload" onclick="document.getElementById('xlsxInput').click()">
            <i class="fas fa-file-excel"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å example_excel.xlsx
        </button>
    </div>
</header>

<div class="tabs">
    <button class="tab-btn active" onclick="showPage('overview', event)">–û–±–∑–æ—Ä</button>
    <button class="tab-btn" onclick="showPage('classes', event)">–ö–ª–∞—Å—Å—ã</button>
    <button class="tab-btn" onclick="showPage('students', event)">–£—á–µ–Ω–∏–∫–∏</button>
    <button class="tab-btn" onclick="showPage('teachers', event)">–£—á–∏—Ç–µ–ª—è</button>
    <button class="tab-btn" onclick="showPage('subjects', event)">–ü—Ä–µ–¥–º–µ—Ç—ã</button>
    <button class="tab-btn" onclick="showPage('attendance', event)">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</button>
    <button class="tab-btn" onclick="showPage('ai-panel', event)">–ò–ò-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è</button>
</div>

<main>
    <!-- 1. OVERVIEW -->
    <div id="overview" class="page active">
        <div class="filters">
            <label>–ß–µ—Ç–≤–µ—Ä—Ç—å: <select id="ovTerm"></select></label>
            <label>–ú–µ—Ç—Ä–∏–∫–∞:
                <select id="ovMetric">
                    <option value="q">–ö–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π</option>
                    <option value="a">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</option>
                </select>
            </label>
            <button class="action-btn" id="ovAIButton" onclick="AppAI.explainOverview()">
                üß† –ò–ò-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
            </button>
            <span id="aiSupportInfo" style="font-size:0.8rem; color:#555;"></span>
        </div>

        <div class="card" id="ovAIBlock" style="display:none; margin-bottom:20px;">
            <h3>–ò–ò-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è (–û–±–∑–æ—Ä)</h3>
            <div id="ovAIText" class="ai-out"></div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-box">
                <div class="kpi-val" id="kpi_stu">0</div>
                <div class="kpi-lbl">–£—á–µ–Ω–∏–∫–æ–≤</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-val" id="kpi_tch">0</div>
                <div class="kpi-lbl">–£—á–∏—Ç–µ–ª–µ–π</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-val" id="kpi_met">-</div>
                <div class="kpi-lbl">–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div style="flex:2; min-width:300px;">
                    <h3>–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –ø–æ –ø–∞—Ä–∞–ª–ª–µ–ª—è–º</h3>
                    <div class="table-container" id="ovTable"></div>
                </div>
                <div style="flex:1; min-width:300px;">
                    <h3>–°—Ç–∞—Ç—É—Å (–í—Å—è —à–∫–æ–ª–∞)</h3>
                    <div id="ovDonut" style="height:300px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. CLASSES -->
    <div id="classes" class="page">
        <div class="filters">
            <label>–ú–µ—Ç—Ä–∏–∫–∞:
                <select id="clMetric" onchange="App.renderClasses()">
                    <option value="q">–ö–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π</option>
                    <option value="a">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</option>
                </select>
            </label>
            <label>–ß–µ—Ç–≤–µ—Ä—Ç—å:
                <select id="clTerm" onchange="App.renderClasses(); App.renderClassDonut();"></select>
            </label>
        </div>
        <div class="card">
            <h3>–†–µ–π—Ç–∏–Ω–≥ –∫–ª–∞—Å—Å–æ–≤</h3>
            <div class="table-container" id="clTable"></div>
        </div>
        <div class="filters">
            <label>–ö–ª–∞—Å—Å: <select id="clSelect" onchange="App.renderClassDonut()"></select></label>
        </div>
        <div class="card">
            <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Å–∞</h3>
            <div id="clDonut" style="height:350px;"></div>
        </div>
    </div>

    <!-- 3. STUDENTS -->
    <div id="students" class="page">
        <div class="filters">
            <label>–ö–ª–∞—Å—Å: <select id="stClass"></select></label>
            <label>–ß–µ—Ç–≤–µ—Ä—Ç—å: <select id="stTerm"></select></label>
            <button class="action-btn" onclick="App.renderStudents()">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
        <div class="card">
            <h3>–í–µ–¥–æ–º–æ—Å—Ç—å</h3>
            <div class="table-container" id="stTable"></div>
        </div>
    </div>

    <!-- 4. TEACHERS -->
    <div id="teachers" class="page">
        <div class="filters">
            <label>–ß–µ—Ç–≤–µ—Ä—Ç—å: <select id="tcTerm" onchange="App.renderTeachers()"></select></label>
            <label>–ú–µ—Ç—Ä–∏–∫–∞:
                <select id="tcMetric" onchange="App.renderTeachers()">
                    <option value="q">–ö–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π</option>
                    <option value="a">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</option>
                </select>
            </label>
        </div>
        <div class="card" style="display:flex; gap:20px; flex-wrap:wrap;">
            <div style="flex:1; min-width:260px;">
                <h3>–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è (–∑–∞–≥–ª—É—à–∫–∞)</h3>
                <div id="tcQual" style="height:300px;"></div>
            </div>
            <div style="flex:1; min-width:260px;">
                <h3>–£—á–∏—Ç–µ–ª—å (–¥–µ—Ç–∞–ª–∏)</h3>
                <select id="tcSel" onchange="App.renderTeacherInd()" style="width:100%; margin-bottom:10px;"></select>
                <div id="tcInd" style="height:260px;"></div>
            </div>
        </div>
        <div class="card">
            <h3>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–∑–∞–≥–ª—É—à–∫–∞)</h3>
            <div class="table-container" id="tcTable"></div>
        </div>
    </div>

    <!-- 5. SUBJECTS -->
    <div id="subjects" class="page">
        <div class="filters">
            <label>–ß–µ—Ç–≤–µ—Ä—Ç—å: <select id="sbTerm" onchange="App.renderSubjects()"></select></label>
            <label>–ú–µ—Ç—Ä–∏–∫–∞:
                <select id="sbMetric" onchange="App.renderSubjects()">
                    <option value="q">–ö–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π</option>
                    <option value="a">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</option>
                </select>
            </label>
        </div>
        <div class="card">
            <h3>–†–µ–π—Ç–∏–Ω–≥ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h3>
            <div id="sbChart" style="height:400px;"></div>
        </div>
        <div class="card">
            <h3>–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞</h3>
            <div id="sbHeatmap" style="height:500px;"></div>
        </div>
    </div>

    <!-- 6. ATTENDANCE -->
    <div id="attendance" class="page">
        <div class="filters">
            <label>–ß–µ—Ç–≤–µ—Ä—Ç—å: <select id="atTerm" onchange="App.renderAttendance()"></select></label>
        </div>
        <div class="card">
            <h3>–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å (–∫–ª–∞—Å—Å—ã)</h3>
            <div class="table-container" id="atTable"></div>
        </div>
        <div class="filters">
            <label>–ö–ª–∞—Å—Å: <select id="atClass" onchange="App.renderAttendanceStudent()"></select></label>
        </div>
        <div class="card">
            <h3>–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å (—É—á–µ–Ω–∏–∫–∏)</h3>
            <div class="table-container" id="atStudentTable"></div>
        </div>
    </div>

    <!-- 7. AI PANEL -->
    <div id="ai-panel" class="page">
        <div class="filters">
            <label>–ú–æ–¥–µ–ª—å –ò–ò:
                <select id="aiModelSelect"></select>
            </label>
            <span id="aiServerInfo" style="font-size:0.8rem; color:#555;"></span>
        </div>

        <div class="card">
            <h3>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á—ë—Ç–∞ –ø–æ —á–µ—Ç–≤–µ—Ä—Ç–∏</h3>
            <p style="margin-top:0;color:#555;font-size:0.9rem;">
                –ò–ò –ø–∏—à–µ—Ç —Å–≤—è–∑–Ω—ã–π –æ—Ç—á—ë—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–∂–µ –ø–æ—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤—ã–¥—É–º–∞–Ω–Ω—ã—Ö —Ü–∏—Ñ—Ä).
            </p>
            <button class="action-btn" id="btnQuarterReport" onclick="AppAI.generateQuarterReport()">
                –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç –ø–æ —á–µ—Ç–≤–µ—Ä—Ç–∏
            </button>
            <div id="quarterReportOut" class="ai-out" style="margin-top:12px;"></div>
        </div>

        <div class="card">
            <h3>–ü–µ–¥—Å–æ–≤–µ—Ç-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</h3>
            <p style="margin-top:0;color:#555;font-size:0.9rem;">
                –ò–ò —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–≤–µ—Å—Ç–∫—É, –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∏ —á–µ—Ä–Ω–æ–≤–∏–∫ —Ä–µ—à–µ–Ω–∏–π.
            </p>
            <button class="action-btn" id="btnPedCouncil" onclick="AppAI.generatePedCouncilAgenda()">
                –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–µ—Å—Ç–∫—É –ø–µ–¥—Å–æ–≤–µ—Ç–∞
            </button>
            <div id="pedCouncilOut" class="ai-out" style="margin-top:12px;"></div>
        </div>
    </div>
</main>

<div id="status-log">System Ready. Please upload Excel file.</div>

<script>
/* ==================== CORE APP ==================== */
const App = {
    state: {
        students: [],
        teachers: [],
        classes: [],
        subjects: [],
        terms: [],
        gradesRaw: [],
        attendanceRaw: [],
        enrollments: [],
        assignments: [],
        processedGrades: [],
        studentStatuses: {},
        weights: { '–§–û': 0.25, '–°–û–†': 0.25, '–°–û–ß': 0.50 }
    },

    init: function () {
        const inp = document.getElementById('xlsxInput');
        if (inp) {
            inp.addEventListener('change', (e) => this.handleFile(e.target.files[0]));
        }
        this.log("System Ready. Please upload Excel file.");
    },

    log: function (msg) {
        console.log(msg);
        const el = document.getElementById('status-log');
        if (el) el.innerText = "> " + msg;
    },

    handleFile: function (file) {
        if (!file) return;
        this.log("Reading Excel file...");
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: 'array' });

                const sheetMap = {
                    '–£–ß–ê–©–ò–ï–°–Ø': 'students',
                    '–£–ß–ò–¢–ï–õ–Ø': 'teachers',
                    '–ö–õ–ê–°–°–´': 'classes',
                    '–ü–†–ï–î–ú–ï–¢–´': 'subjects',
                    '–ß–ï–¢–í–ï–†–¢–ò': 'terms',
                    '–û–¶–ï–ù–ö–ò': 'gradesRaw',
                    '–ü–û–°–ï–©–ê–ï–ú–û–°–¢–¨': 'attendanceRaw',
                    '–°–û–°–¢–ê–í_–ö–õ–ê–°–°–ê': 'enrollments',
                    '–ù–ê–ó–ù–ê–ß–ï–ù–ò–Ø_–ü–†–ï–ü–û–î': 'assignments'
                };

                wb.SheetNames.forEach(sheetName => {
                    const upper = sheetName.toUpperCase();
                    const key = Object.keys(sheetMap).find(k => upper.includes(k));
                    if (key) {
                        const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                        this.state[sheetMap[key]] = jsonData;
                        this.log(`Loaded sheet: ${sheetName} (${jsonData.length} rows)`);
                    }
                });

                if (this.state.gradesRaw.length === 0) {
                    alert("Sheet '–û–¶–ï–ù–ö–ò' not found in Excel!");
                    return;
                }

                this.processData();
            } catch (err) {
                console.error(err);
                alert("Error parsing Excel: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    },

    mean: function (arr) {
        return arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
    },

    processData: function () {
        this.log("Calculating grades...");
        const { gradesRaw, weights } = this.state;
        const groups = {};

        gradesRaw.forEach(r => {
            if (!r.student_id || !r.subject_id || !r.term_id) return;
            const key = `${r.student_id}|${r.subject_id}|${r.term_id}`;
            if (!groups[key]) {
                groups[key] = {
                    student_id: r.student_id,
                    subject_id: r.subject_id,
                    term_id: r.term_id,
                    class_id: r.class_id,
                    fo: [],
                    sor: [],
                    soch: []
                };
            }

            let val = parseFloat(r.percent);
            if (isNaN(val) && r.score != null && r.max_score != null) {
                val = r.score / r.max_score;
            }
            if (isNaN(val)) return;
            if (val > 1) val = val / 100;

            const type = (r.work_type || '').toUpperCase();
            if (type.includes('–§–û')) groups[key].fo.push(val);
            else if (type.includes('–°–û–†')) groups[key].sor.push(val);
            else groups[key].soch.push(val);
        });

        const processed = [];
        const wFO = weights['–§–û'] || 0.25;
        const wSOR = weights['–°–û–†'] || 0.25;
        const wSOCH = weights['–°–û–ß'] || 0.5;

        Object.values(groups).forEach(g => {
            const avgFO = this.mean(g.fo);
            const avgSOR = this.mean(g.sor);
            const avgSOCH = this.mean(g.soch);

            let total = 0;
            let wTotal = 0;

            if (g.fo.length) { total += avgFO * wFO; wTotal += wFO; }
            if (g.sor.length) { total += avgSOR * wSOR; wTotal += wSOR; }
            if (g.soch.length) { total += avgSOCH * wSOCH; wTotal += wSOCH; }

            const pct = wTotal > 0 ? (total / wTotal) * 100 : 0;

            let grade = 2;
            if (pct >= 85) grade = 5;
            else if (pct >= 70) grade = 4;
            else if (pct >= 55) grade = 3;

            processed.push({
                student_id: g.student_id,
                subject_id: g.subject_id,
                term_id: g.term_id,
                class_id: g.class_id,
                percent: pct,
                grade: grade
            });
        });

        this.state.processedGrades = processed;
        this.calcStatuses();
        this.initUI();
        this.log("Dashboard Ready!");
    },

    calcStatuses: function () {
        const tGrades = {};
        this.state.processedGrades.forEach(p => {
            const key = `${p.student_id}|${p.term_id}`;
            if (!tGrades[key]) tGrades[key] = [];
            tGrades[key].push(p.grade);
        });

        Object.entries(tGrades).forEach(([key, arr]) => {
            let st = '–î–≤–æ–µ—á–Ω–∏–∫';
            if (arr.includes(2)) st = '–î–≤–æ–µ—á–Ω–∏–∫';
            else if (arr.includes(3)) st = '–¢—Ä–æ–µ—á–Ω–∏–∫';
            else if (arr.includes(4)) st = '–•–æ—Ä–æ—à–∏—Å—Ç';
            else st = '–û—Ç–ª–∏—á–Ω–∏–∫';
            this.state.studentStatuses[key] = st;
        });
    },

    initUI: function () {
        const terms = [...new Set(this.state.processedGrades.map(r => r.term_id))].sort();
        const fillSelect = (id, options, withAll = false) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.innerHTML = '';
            if (withAll) {
                const opt = document.createElement('option');
                opt.value = 'ALL';
                opt.textContent = '–í–µ—Å—å –≥–æ–¥';
                el.appendChild(opt);
            }
            options.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.value;
                opt.textContent = o.label;
                el.appendChild(opt);
            });
        };

        const termOpts = terms.map(t => ({ value: t, label: t }));
        fillSelect('ovTerm', termOpts, true);
        fillSelect('clTerm', termOpts, false);
        fillSelect('stTerm', termOpts, false);
        fillSelect('tcTerm', termOpts, false);
        fillSelect('sbTerm', termOpts, false);
        fillSelect('atTerm', termOpts, false);

        const classOpts = this.state.classes.map(c => ({
            value: c.class_id,
            label: c.class_name
        }));
        fillSelect('clSelect', classOpts, false);
        fillSelect('stClass', classOpts, false);
        fillSelect('atClass', classOpts, false);

        const tchOpts = this.state.teachers.map(t => ({
            value: t.teacher_id,
            label: `${t.last_name || ''} ${t.first_name || ''}`.trim() || t.teacher_id
        }));
        fillSelect('tcSel', tchOpts, false);

        document.getElementById('ovTerm').addEventListener('change', () => this.renderOverview());
        document.getElementById('ovMetric').addEventListener('change', () => this.renderOverview());

        this.renderOverview();
        this.renderClasses();
        this.renderSubjects();
        this.renderAttendance();
    },

    /* ---------- common helpers for analytics & AI ---------- */
    getMetricValue: function (rows, metric) {
        if (!rows.length) return null;
        if (metric === 'a') return this.mean(rows.map(r => r.grade));
        return (rows.filter(r => r.grade >= 4).length / rows.length) * 100;
    },

    getClassesRanking: function (term, metric) {
        const data = term === 'ALL'
            ? this.state.processedGrades
            : this.state.processedGrades.filter(r => r.term_id === term);

        const out = [];
        this.state.classes.forEach(c => {
            const rows = data.filter(r => r.class_id === c.class_id);
            const v = this.getMetricValue(rows, metric);
            if (v !== null) out.push({ class_id: c.class_id, class_name: c.class_name, val: v });
        });
        out.sort((a, b) => b.val - a.val);
        return out;
    },

    getSubjectsRanking: function (term, metric) {
        const data = term === 'ALL'
            ? this.state.processedGrades
            : this.state.processedGrades.filter(r => r.term_id === term);

        const out = [];
        this.state.subjects.forEach(s => {
            const rows = data.filter(r => r.subject_id === s.subject_id);
            const v = this.getMetricValue(rows, metric);
            if (v !== null) out.push({ subject_id: s.subject_id, subject_name: s.subject_name, val: v });
        });
        out.sort((a, b) => b.val - a.val);
        return out;
    },

    getAttendanceSummary: function (term) {
        const raw = this.state.attendanceRaw.filter(r => r.term_id === term);
        if (!raw.length) return null;

        const classStats = [];
        this.state.classes.forEach(c => {
            const rows = raw.filter(r => r.class_id === c.class_id);
            if (!rows.length) return;
            const total = rows.reduce((a, b) => a + (parseInt(b.total_classes) || 0), 0);
            const pres = rows.reduce((a, b) => a + (parseInt(b.present_classes) || 0), 0);
            const exc = rows.reduce((a, b) => a + (parseInt(b.absent_excused_classes) || 0), 0);
            const unexc = rows.reduce((a, b) => a + (parseInt(b.absent_unexcused_classes) || 0), 0);
            const late = rows.reduce((a, b) => a + (parseInt(b.late_classes) || 0), 0);
            const pct = total ? (pres / total) * 100 : 0;
            classStats.push({ class_id: c.class_id, class_name: c.class_name, total, pres, exc, unexc, late, pct });
        });

        const overall = classStats.reduce((acc, x) => {
            acc.total += x.total;
            acc.pres += x.pres;
            acc.exc += x.exc;
            acc.unexc += x.unexc;
            acc.late += x.late;
            return acc;
        }, { total: 0, pres: 0, exc: 0, unexc: 0, late: 0 });

        overall.pct = overall.total ? (overall.pres / overall.total) * 100 : 0;

        classStats.sort((a, b) => a.pct - b.pct);
        const worst = classStats.slice(0, 3);
        const best = classStats.slice(-3).reverse();

        return { overall, worst, best, classStats };
    },

    buildOverviewSummary: function () {
        const termEl = document.getElementById('ovTerm');
        const metricEl = document.getElementById('ovMetric');
        const term = termEl ? termEl.value : 'ALL';
        const metric = metricEl ? metricEl.value : 'q';

        const termLabel = term === 'ALL' ? '–≤–µ—Å—å —É—á–µ–±–Ω—ã–π –≥–æ–¥' : `—á–µ—Ç–≤–µ—Ä—Ç—å ${term}`;
        const metricLabel = metric === 'a'
            ? '–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ (—Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ 5-–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ)'
            : '–ö–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π (–¥–æ–ª—è —É—á–µ–Ω–∏–∫–æ–≤ —Å –æ—Ü–µ–Ω–∫–∞–º–∏ 4‚Äì5)';

        const allGrades = this.state.processedGrades || [];
        const data = term === 'ALL'
            ? allGrades
            : allGrades.filter(r => r.term_id === term);

        const totalStudents = (this.state.students || []).length;
        const totalTeachers = (this.state.teachers || []).length;

        let schoolMetricValue = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        if (data.length) {
            if (metric === 'a') {
                schoolMetricValue = this.mean(data.map(r => r.grade)).toFixed(2);
            } else {
                const q = (data.filter(r => r.grade >= 4).length / data.length) * 100;
                schoolMetricValue = q.toFixed(1) + '%';
            }
        }

        const statusCounts = {
            '–û—Ç–ª–∏—á–Ω–∏–∫': 0,
            '–•–æ—Ä–æ—à–∏—Å—Ç': 0,
            '–¢—Ä–æ–µ—á–Ω–∏–∫': 0,
            '–î–≤–æ–µ—á–Ω–∏–∫': 0
        };
        const statuses = this.state.studentStatuses || {};
        Object.entries(statuses).forEach(([k, st]) => {
            const t = k.split('|')[1];
            if (term === 'ALL' || t === term) {
                if (statusCounts[st] !== undefined) statusCounts[st] += 1;
            }
        });
        const totalStatus = Object.values(statusCounts).reduce((a, b) => a + b, 0) || 1;
        const statusPct = {};
        for (let s in statusCounts) {
            statusPct[s] = ((statusCounts[s] / totalStatus) * 100).toFixed(1);
        }

        const parallelStats = [];
        for (let i = 1; i <= 11; i++) {
            const rows = data.filter(r => {
                const c = (this.state.classes || []).find(cls => cls.class_id === r.class_id);
                return c && String(c.class_name).startsWith(i.toString());
            });
            if (!rows.length) continue;
            let v;
            if (metric === "a") v = this.mean(rows.map(r => r.grade));
            else v = (rows.filter(r => r.grade >= 4).length / rows.length) * 100;
            parallelStats.push({ parallel: i, val: v });
        }
        parallelStats.sort((a, b) => b.val - a.val);
        const bestParallel = parallelStats[0] || null;
        const worstParallel = parallelStats.length > 1 ? parallelStats[parallelStats.length - 1] : null;

        let text = "";
        text += `–ü–µ—Ä–∏–æ–¥: ${termLabel}.\n`;
        text += `–í—Å–µ–≥–æ —É—á–µ–Ω–∏–∫–æ–≤: ${totalStudents}. –í—Å–µ–≥–æ —É—á–∏—Ç–µ–ª–µ–π: ${totalTeachers}.\n`;
        text += `–í—ã–±—Ä–∞–Ω–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞: ${metricLabel}.\n`;
        text += `–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å –ø–æ —à–∫–æ–ª–µ: ${schoolMetricValue}.\n\n`;

        text += "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—á–∞—â–∏—Ö—Å—è –ø–æ —É—á–µ–±–Ω—ã–º —Å—Ç–∞—Ç—É—Å–∞–º (—É—á–µ–Ω–∏–∫‚Äì—á–µ—Ç–≤–µ—Ä—Ç—å):\n";
        text += `- –û—Ç–ª–∏—á–Ω–∏–∫–∏: ${statusCounts["–û—Ç–ª–∏—á–Ω–∏–∫"]} (${statusPct["–û—Ç–ª–∏—á–Ω–∏–∫"]}%).\n`;
        text += `- –•–æ—Ä–æ—à–∏—Å—Ç—ã: ${statusCounts["–•–æ—Ä–æ—à–∏—Å—Ç"]} (${statusPct["–•–æ—Ä–æ—à–∏—Å—Ç"]}%).\n`;
        text += `- –¢—Ä–æ–µ—á–Ω–∏–∫–∏: ${statusCounts["–¢—Ä–æ–µ—á–Ω–∏–∫"]} (${statusPct["–¢—Ä–æ–µ—á–Ω–∏–∫"]}%).\n`;
        text += `- –î–≤–æ–µ—á–Ω–∏–∫–∏: ${statusCounts["–î–≤–æ–µ—á–Ω–∏–∫"]} (${statusPct["–î–≤–æ–µ—á–Ω–∏–∫"]}%).\n\n`;

        if (bestParallel) {
            const v = metric === "a"
                ? bestParallel.val.toFixed(2)
                : bestParallel.val.toFixed(1) + "%";
            text += `–°–∏–ª—å–Ω–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª—å: ${bestParallel.parallel} –∫–ª–∞—Å—Å—ã (‚âà ${v}).\n`;
        }
        if (bestParallel && worstParallel && bestParallel.parallel !== worstParallel.parallel) {
            const v = metric === "a"
                ? worstParallel.val.toFixed(2)
                : worstParallel.val.toFixed(1) + "%";
            text += `–°–ª–∞–±–µ–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö: ${worstParallel.parallel} –∫–ª–∞—Å—Å—ã (‚âà ${v}).\n`;
        }

        return text;
    },

    buildQuarterReportSummary: function () {
        const term = document.getElementById('ovTerm')?.value || 'ALL';
        const metric = document.getElementById('ovMetric')?.value || 'q';
        const termLabel = term === 'ALL' ? '–≤–µ—Å—å –≥–æ–¥' : `—á–µ—Ç–≤–µ—Ä—Ç—å ${term}`;
        const metricLabel = metric === 'a' ? '—Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞' : '–∫–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π';

        const ov = this.buildOverviewSummary();

        const classRank = this.getClassesRanking(term, metric);
        const topClasses = classRank.slice(0, 3);
        const lowClasses = classRank.slice(-3);

        const subjRank = this.getSubjectsRanking(term, metric);
        const topSubj = subjRank.slice(0, 3);
        const lowSubj = subjRank.slice(-3);

        const att = term !== 'ALL' ? this.getAttendanceSummary(term) : null;

        let t = "";
        t += `–°–≤–æ–¥–∫–∞ –¥–ª—è –æ—Ç—á—ë—Ç–∞. –ü–µ—Ä–∏–æ–¥: ${termLabel}. –ú–µ—Ç—Ä–∏–∫–∞: ${metricLabel}.\n\n`;
        t += `1) –û–±–∑–æ—Ä –ø–æ —à–∫–æ–ª–µ:\n${ov}\n\n`;

        t += `2) –¢–û–ü-3 –∫–ª–∞—Å—Å–æ–≤ –ø–æ –º–µ—Ç—Ä–∏–∫–µ (${metricLabel}):\n`;
        topClasses.forEach((x, i) => {
            const v = metric === 'a' ? x.val.toFixed(2) : x.val.toFixed(1) + '%';
            t += `${i + 1}. ${x.class_name} ‚Äî ${v}\n`;
        });

        t += `\n–ê–Ω—Ç–∏—Ç–æ–ø-3 –∫–ª–∞—Å—Å–æ–≤:\n`;
        lowClasses.forEach((x, i) => {
            const v = metric === 'a' ? x.val.toFixed(2) : x.val.toFixed(1) + '%';
            t += `${i + 1}. ${x.class_name} ‚Äî ${v}\n`;
        });

        t += `\n3) –¢–û–ü-3 –ø—Ä–µ–¥–º–µ—Ç–æ–≤:\n`;
        topSubj.forEach((x, i) => {
            const v = metric === 'a' ? x.val.toFixed(2) : x.val.toFixed(1) + '%';
            t += `${i + 1}. ${x.subject_name} ‚Äî ${v}\n`;
        });

        t += `\n–ê–Ω—Ç–∏—Ç–æ–ø-3 –ø—Ä–µ–¥–º–µ—Ç–æ–≤:\n`;
        lowSubj.forEach((x, i) => {
            const v = metric === 'a' ? x.val.toFixed(2) : x.val.toFixed(1) + '%';
            t += `${i + 1}. ${x.subject_name} ‚Äî ${v}\n`;
        });

        if (att) {
            t += `\n4) –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å:\n`;
            t += `- –ü–æ —à–∫–æ–ª–µ: ${att.overall.pct.toFixed(1)}% –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–π.\n`;
            t += `- –ö–ª–∞—Å—Å—ã —Å –Ω–∞–∏—Ö—É–¥—à–µ–π –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å—é:\n`;
            att.worst.forEach(x => {
                t += `  ‚Ä¢ ${x.class_name} ‚Äî ${x.pct.toFixed(1)}%.\n`;
            });
        } else {
            t += `\n4) –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –≤—ã–±—Ä–∞–Ω –≤–µ—Å—å –≥–æ–¥.\n`;
        }

        return t;
    },

    buildPedCouncilFacts: function () {
        const term = document.getElementById('ovTerm')?.value || 'ALL';
        const metric = document.getElementById('ovMetric')?.value || 'q';
        const metricLabel = metric === 'a' ? '—Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞' : '–∫–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π';

        const classRank = this.getClassesRanking(term, metric);
        const subjRank = this.getSubjectsRanking(term, metric);

        const weakestClass = classRank[classRank.length - 1];
        const strongestClass = classRank[0];
        const weakestSubj = subjRank[subjRank.length - 1];
        const strongestSubj = subjRank[0];

        const vStr = (x) => metric === 'a' ? x.val.toFixed(2) : x.val.toFixed(1) + '%';

        let t = "";
        t += `–§–∞–∫—Ç—ã –¥–ª—è –ø–µ–¥—Å–æ–≤–µ—Ç–∞ (${term === 'ALL' ? '–≥–æ–¥' : '—á–µ—Ç–≤–µ—Ä—Ç—å ' + term}, –º–µ—Ç—Ä–∏–∫–∞=${metricLabel}):\n`;
        if (strongestClass && weakestClass) {
            t += `- –°–∞–º—ã–π —Å–∏–ª—å–Ω—ã–π –∫–ª–∞—Å—Å: ${strongestClass.class_name} (‚âà ${vStr(strongestClass)}).\n`;
            t += `- –°–∞–º—ã–π —Å–ª–∞–±—ã–π –∫–ª–∞—Å—Å: ${weakestClass.class_name} (‚âà ${vStr(weakestClass)}).\n`;
        }
        if (strongestSubj && weakestSubj) {
            t += `- –°–∏–ª—å–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç: ${strongestSubj.subject_name} (‚âà ${vStr(strongestSubj)}).\n`;
            t += `- –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç: ${weakestSubj.subject_name} (‚âà ${vStr(weakestSubj)}).\n`;
        }
        t += `- –°–º. —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ —É—á–µ–Ω–∏–∫–æ–≤ –∏ –ø–∞—Ä–∞–ª–ª–µ–ª–µ–π –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–û–±–∑–æ—Ä¬ª.\n`;
        return t;
    },

    /* ---------- RENDER: OVERVIEW ---------- */
    renderOverview: function () {
        const term = document.getElementById('ovTerm').value;
        const metric = document.getElementById('ovMetric').value;
        const data = term === 'ALL'
            ? this.state.processedGrades
            : this.state.processedGrades.filter(r => r.term_id === term);

        document.getElementById('kpi_stu').innerText = this.state.students.length;
        document.getElementById('kpi_tch').innerText = this.state.teachers.length;

        let val = '-';
        if (data.length) {
            if (metric === 'a') {
                val = this.mean(data.map(r => r.grade)).toFixed(2);
            } else {
                val = ((data.filter(r => r.grade >= 4).length / data.length) * 100).toFixed(1) + '%';
            }
        }
        document.getElementById('kpi_met').innerText = val;

        const terms = [...new Set(this.state.processedGrades.map(r => r.term_id))].sort();
        let html = '<table><thead><tr><th>–ü–∞—Ä–∞–ª–ª–µ–ª—å</th>';
        terms.forEach(t => html += `<th>${t}</th>`);
        html += '</tr></thead><tbody>';

        for (let i = 1; i <= 11; i++) {
            html += `<tr><td><b>${i} –∫–ª–∞—Å—Å—ã</b></td>`;
            terms.forEach(t => {
                const rows = this.state.processedGrades.filter(r => r.term_id === t);
                const subset = rows.filter(r => {
                    const c = this.state.classes.find(cls => cls.class_id === r.class_id);
                    return c && String(c.class_name).startsWith(i.toString());
                });

                let cell = '-', bg = '';
                if (subset.length) {
                    if (metric === 'a') {
                        const v = this.mean(subset.map(r => r.grade)).toFixed(2);
                        bg = parseFloat(v) >= 4 ? '#d4edda' : '#f8d7da';
                        cell = v;
                    } else {
                        const q = (subset.filter(r => r.grade >= 4).length / subset.length) * 100;
                        const v = Math.round(q) + '%';
                        bg = q > 50 ? '#d4edda' : '#f8d7da';
                        cell = v;
                    }
                }
                html += `<td style="background:${bg}">${cell}</td>`;
            });
            html += '</tr>';
        }
        html += '</tbody></table>';
        document.getElementById('ovTable').innerHTML = html;

        const counts = { '5': 0, '4': 0, '3': 0, '2': 0 };
        Object.entries(this.state.studentStatuses).forEach(([k, st]) => {
            const t = k.split('|')[1];
            if (term === 'ALL' || t === term) {
                if (st === '–û—Ç–ª–∏—á–Ω–∏–∫') counts['5']++;
                else if (st === '–•–æ—Ä–æ—à–∏—Å—Ç') counts['4']++;
                else if (st === '–¢—Ä–æ–µ—á–Ω–∏–∫') counts['3']++;
                else counts['2']++;
            }
        });

        Plotly.newPlot('ovDonut', [{
            values: Object.values(counts),
            labels: ['–û—Ç–ª–∏—á–Ω–∏–∫', '–•–æ—Ä–æ—à–∏—Å—Ç', '–¢—Ä–æ–µ—á–Ω–∏–∫', '–î–≤–æ–µ—á–Ω–∏–∫'],
            type: 'pie',
            marker: { colors: ['#2ecc71', '#3498db', '#f1c40f', '#e74c3c'] },
            hole: 0.4
        }], { margin: { t: 0, b: 0, l: 0, r: 0 } });
    },

    /* ---------- RENDER: CLASSES ---------- */
    renderClasses: function () {
        const term = document.getElementById('clTerm').value || 'ALL';
        const metric = document.getElementById('clMetric').value;
        const ranking = this.getClassesRanking(term, metric);

        let html = '<table><thead><tr><th>#</th><th>–ö–ª–∞—Å—Å</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr></thead><tbody>';
        ranking.forEach((c, i) => {
            const v = metric === 'a' ? c.val.toFixed(2) : c.val.toFixed(1) + '%';
            html += `<tr><td>${i + 1}</td><td>${c.class_name}</td><td>${v}</td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('clTable').innerHTML = html;
    },

    renderClassDonut: function () {
        const term = document.getElementById('clTerm').value || 'ALL';
        const classId = document.getElementById('clSelect').value;
        if (!classId) {
            document.getElementById('clDonut').innerHTML = '';
            return;
        }

        const data = term === 'ALL'
            ? this.state.processedGrades.filter(r => r.class_id === classId)
            : this.state.processedGrades.filter(r => r.class_id === classId && r.term_id === term);

        const counts = { 5: 0, 4: 0, 3: 0, 2: 0 };
        data.forEach(r => { counts[r.grade] = (counts[r.grade] || 0) + 1; });

        Plotly.newPlot('clDonut', [{
            values: [counts[5], counts[4], counts[3], counts[2]],
            labels: ['5', '4', '3', '2'],
            type: 'pie',
            hole: 0.4
        }], { margin: { t: 0, b: 0, l: 0, r: 0 } });
    },

    /* ---------- RENDER: STUDENTS ---------- */
    renderStudents: function () {
        const classId = document.getElementById('stClass').value;
        const term = document.getElementById('stTerm').value;
        if (!classId || !term) {
            document.getElementById('stTable').innerHTML = "–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –∏ —á–µ—Ç–≤–µ—Ä—Ç—å";
            return;
        }

        const rows = this.state.processedGrades.filter(r => r.class_id === classId && r.term_id === term);
        const byStu = {};
        rows.forEach(r => {
            if (!byStu[r.student_id]) byStu[r.student_id] = [];
            byStu[r.student_id].push(r.grade);
        });

        let html = '<table><thead><tr><th>–£—á–µ–Ω–∏–∫</th><th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>';
        Object.entries(byStu).forEach(([stuId, arr]) => {
            const avg = this.mean(arr);
            const student = this.state.students.find(s => s.student_id === stuId) || {};
            const name = `${student.last_name || ''} ${student.first_name || ''}`.trim() || stuId;
            const st = this.state.studentStatuses[`${stuId}|${term}`] || '';
            html += `<tr><td>${name}</td><td>${avg.toFixed(2)}</td><td>${st}</td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('stTable').innerHTML = html;
    },

    /* ---------- RENDER: TEACHERS (simplified placeholders) ---------- */
    renderTeachers: function () {
        document.getElementById('tcQual').innerHTML =
            "<p style='font-size:0.9rem;color:#666;'>–ü–æ–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞. " +
            "–°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—á–∏—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∑–∞–≥–ª—É—à–∫–∞.</p>";
        document.getElementById('tcInd').innerHTML = "";
        document.getElementById('tcTable').innerHTML =
            "<p style='font-size:0.9rem;color:#666;padding:10px;'>–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ —É—á–∏—Ç–µ–ª–µ–π, " +
            "–∏—Ö –Ω–∞–≥—Ä—É–∑–∫—É –∏ –∫–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º.</p>";
    },

    renderTeacherInd: function () {
        const tcInd = document.getElementById('tcInd');
        const sel = document.getElementById('tcSel');
        const name = sel && sel.options[sel.selectedIndex]
            ? sel.options[sel.selectedIndex].textContent
            : '';
        tcInd.innerHTML = `<p style='font-size:0.9rem;color:#666;'>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —É—á–∏—Ç–µ–ª—è: <b>${name}</b>. 
            –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ.</p>`;
    },

    /* ---------- RENDER: SUBJECTS ---------- */
    renderSubjects: function () {
        const term = document.getElementById('sbTerm').value;
        const metric = document.getElementById('sbMetric').value;
        const ranking = this.getSubjectsRanking(term, metric);

        // Bar chart
        const x = ranking.map(r => r.subject_name);
        const y = ranking.map(r => metric === 'a' ? r.val.toFixed(2) : r.val.toFixed(1));
        Plotly.newPlot('sbChart', [{
            x: y,
            y: x,
            type: 'bar',
            orientation: 'h'
        }], {
            margin: { l: 120, r: 20, t: 10, b: 40 }
        });

        // Heatmap: subjects (y) x classes (x)
        const classes = this.state.classes;
        const subjects = this.state.subjects;
        const xLabels = classes.map(c => c.class_name);
        const yLabels = subjects.map(s => s.subject_name);
        const z = [];

        subjects.forEach(s => {
            const row = [];
            classes.forEach(c => {
                const rows = this.state.processedGrades.filter(r =>
                    r.subject_id === s.subject_id &&
                    r.class_id === c.class_id &&
                    r.term_id === term
                );
                const v = this.getMetricValue(rows, metric);
                row.push(v == null ? null : v);
            });
            z.push(row);
        });

        Plotly.newPlot('sbHeatmap', [{
            z: z,
            x: xLabels,
            y: yLabels,
            type: 'heatmap',
            zauto: true
        }], {
            margin: { l: 150, r: 20, t: 10, b: 80 },
            xaxis: { tickangle: -45 }
        });
    },

    /* ---------- RENDER: ATTENDANCE ---------- */
    renderAttendance: function () {
        const term = document.getElementById('atTerm').value;
        const summary = this.getAttendanceSummary(term);
        if (!summary) {
            document.getElementById('atTable').innerHTML = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏.";
            return;
        }

        let html = '<table><thead><tr>' +
            '<th>–ö–ª–∞—Å—Å</th><th>–í—Å–µ–≥–æ —É—Ä–æ–∫–æ–≤</th><th>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–π</th>' +
            '<th>–£–≤–∞–∂. –ø—Ä–æ–ø—É—Å–∫–∏</th><th>–ù–µ—É–≤–∞–∂. –ø—Ä–æ–ø—É—Å–∫–∏</th><th>–û–ø–æ–∑–¥–∞–Ω–∏—è</th><th>% –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–π</th>' +
            '</tr></thead><tbody>';

        summary.classStats.forEach(s => {
            html += `<tr><td>${s.class_name}</td><td>${s.total}</td><td>${s.pres}</td>` +
                `<td>${s.exc}</td><td>${s.unexc}</td><td>${s.late}</td>` +
                `<td>${s.pct.toFixed(1)}%</td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('atTable').innerHTML = html;
    },

    renderAttendanceStudent: function () {
        const term = document.getElementById('atTerm').value;
        const classId = document.getElementById('atClass').value;
        const rows = this.state.attendanceRaw.filter(r => r.term_id === term && r.class_id === classId);

        if (!rows.length) {
            document.getElementById('atStudentTable').innerHTML = "–ù–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ —É—á–µ–Ω–∏–∫–∞–º.";
            return;
        }

        let html = '<table><thead><tr><th>–£—á–µ–Ω–∏–∫</th><th>–í—Å–µ–≥–æ</th><th>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª</th>' +
            '<th>–£–≤–∞–∂. –ø—Ä–æ–ø—É—Å–∫–∏</th><th>–ù–µ—É–≤–∞–∂. –ø—Ä–æ–ø—É—Å–∫–∏</th><th>–û–ø–æ–∑–¥–∞–Ω–∏—è</th></tr></thead><tbody>';

        rows.forEach(r => {
            const stu = this.state.students.find(s => s.student_id === r.student_id) || {};
            const name = `${stu.last_name || ''} ${stu.first_name || ''}`.trim() || r.student_id;
            html += `<tr><td>${name}</td>` +
                `<td>${r.total_classes || ''}</td>` +
                `<td>${r.present_classes || ''}</td>` +
                `<td>${r.absent_excused_classes || ''}</td>` +
                `<td>${r.absent_unexcused_classes || ''}</td>` +
                `<td>${r.late_classes || ''}</td></tr>`;
        });

        html += '</tbody></table>';
        document.getElementById('atStudentTable').innerHTML = html;
    }
};

window.App = App;

/* ==================== WebLLM CLIENT (WebGPU) ==================== */
const LLMClient = {
    engine: null,
    ready: false,
    modelId: "Llama-3.2-1B-Instruct-q4f32_1-MLC", // –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å WebLLM

    async init() {
        const info = document.getElementById("aiSupportInfo");
        const info2 = document.getElementById("aiServerInfo");
        const sel = document.getElementById("aiModelSelect");

        const setMsg = (msg) => {
            if (info) info.textContent = msg;
            if (info2) info2.textContent = msg;
        };

        try {
            setMsg("–ó–∞–≥—Ä—É–∂–∞–µ–º WebLLM –º–æ–¥–µ–ª—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ (WebGPU)...");

            const webllm = await import("https://esm.run/@mlc-ai/web-llm");
            const { CreateMLCEngine } = webllm;

            this.engine = await CreateMLCEngine(this.modelId, {
                initProgressCallback: (report) => {
                    const p = Math.round((report.progress || 0) * 100);
                    setMsg(`–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ ${this.modelId}: ${p}% ...`);
                }
            });

            this.ready = true;

            if (sel) {
                sel.innerHTML = "";
                const opt = document.createElement("option");
                opt.value = this.modelId;
                opt.textContent = this.modelId + " (WebGPU, –ª–æ–∫–∞–ª—å–Ω–æ)";
                sel.appendChild(opt);
            }

            setMsg("WebLLM –≥–æ—Ç–æ–≤. –ú–æ–¥–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞).");
        } catch (e) {
            console.error(e);
            this.ready = false;
            setMsg("WebLLM/WebGPU –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ (fallback).");
        }
    },

    async call(fullPrompt, { max_tokens = 700, temperature = 0.2 } = {}) {
        if (!this.ready || !this.engine) {
            throw new Error("WebLLM engine not ready");
        }

        const messages = [
            {
                role: "system",
                content:
                    "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫-–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ —à–∫–æ–ª—ã. " +
                    "–û–ø–∏—Ä–∞–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
            },
            {
                role: "user",
                content: fullPrompt
            }
        ];

        const reply = await this.engine.chat.completions.create({
            messages,
            temperature,
            max_tokens
        });

        const choice = reply.choices && reply.choices[0];
        return (choice && choice.message && choice.message.content) || "";
    }
};
window.LLMClient = LLMClient;

/* ==================== AI LOGIC (AppAI) ==================== */
window.AppAI = {
    async explainOverview() {
        const summary = window.App.buildOverviewSummary();
        const block = document.getElementById('ovAIBlock');
        const textEl = document.getElementById('ovAIText');
        const btn = document.getElementById("ovAIButton");

        if (block) block.style.display = 'block';
        if (textEl) textEl.textContent = "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...";

        if (btn) btn.disabled = true;
        try {
            if (!window.LLMClient?.ready) {
                textEl.textContent = summary + "\n\n(–ò–ò –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–∫–∞–∑–∞–Ω–∞ —á–∏—Å–ª–æ–≤–∞—è —Å–≤–æ–¥–∫–∞.)";
                return;
            }

            const systemPrompt =
                "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫-–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ —à–∫–æ–ª—ã –∏ —É—á–∏—Ç–µ–ª–µ–π. " +
                "–û–ø–∏—Ä–∞–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —á–∏—Å–ª–∞ –∏ —Ñ–∞–∫—Ç—ã –∏–∑ —Å–≤–æ–¥–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. " +
                "–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–µ –º–µ–Ω—è–π —Ü–∏—Ñ—Ä—ã. " +
                "–ü–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏ –ø–æ-–¥–µ–ª–æ–≤–æ–º—É. " +
                "–î–∞–π –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ –≤—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.";

            const userPrompt =
                "–í–æ—Ç —Å–≤–æ–¥–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ø–æ —à–∫–æ–ª–µ (–æ–±–∑–æ—Ä –¥—ç—à–±–æ—Ä–¥–∞):\n\n" +
                summary +
                "\n\n–°–¥–µ–ª–∞–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –¥–ª—è –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–≤–µ—Ç–∞:\n" +
                "1) –ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É.\n" +
                "2) –í—ã–¥–µ–ª–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã.\n" +
                "3) –û–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–æ–Ω—ã.\n" +
                "4) –î–∞–π 3‚Äì5 –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.\n" +
                "–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —á–∏—Å–µ–ª —Å–≤–µ—Ä—Ö —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤ —Å–≤–æ–¥–∫–µ.";

            const prompt = systemPrompt + "\n\n" + userPrompt;
            const reply = await window.LLMClient.call(prompt, { max_tokens: 700, temperature: 0.2 });
            textEl.textContent = reply || (summary + "\n\n(–û—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑–∞–Ω–∞ —Å–≤–æ–¥–∫–∞.)");
        } catch (err) {
            console.error(err);
            textEl.textContent = summary + "\n\n(–û—à–∏–±–∫–∞ WebLLM, –ø–æ–∫–∞–∑–∞–Ω–∞ —Å–≤–æ–¥–∫–∞.)";
        } finally {
            if (btn) btn.disabled = false;
        }
    },

    async generateQuarterReport() {
        const out = document.getElementById("quarterReportOut");
        const btn = document.getElementById("btnQuarterReport");
        if (out) out.textContent = "–ì–æ—Ç–æ–≤–∏–º –æ—Ç—á—ë—Ç...";
        if (btn) btn.disabled = true;

        try {
            const summary = window.App.buildQuarterReportSummary();

            if (!window.LLMClient?.ready) {
                out.textContent = summary + "\n\n(–ò–ò –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —ç—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è —Å–≤–æ–¥–∫–∞ –¥–ª—è –æ—Ç—á—ë—Ç–∞.)";
                return;
            }

            const systemPrompt =
                "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –∑–∞–≤—É—á–∞/–¥–∏—Ä–µ–∫—Ç–æ—Ä–∞. " +
                "–ü–∏—à–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –ø–æ —á–µ—Ç–≤–µ—Ä—Ç–∏ –Ω–∞ 1‚Äì2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã. " +
                "–û–ø–∏—Ä–∞–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –¥–∞–Ω–Ω—ã–µ —Å–≤–æ–¥–∫–∏. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ü–∏—Ñ—Ä. " +
                "–°—Ç—Ä—É–∫—Ç—É—Ä–∞: –≤–≤–æ–¥–Ω–∞—è, —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å, –∫–ª–∞—Å—Å—ã, –ø—Ä–µ–¥–º–µ—Ç—ã, –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å, –≤—ã–≤–æ–¥—ã, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.";

            const userPrompt =
                "–°–≤–æ–¥–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á—ë—Ç–∞:\n\n" +
                summary +
                "\n\n–°—Ñ–æ—Ä–º–∏—Ä—É–π —Å–≤—è–∑–Ω—ã–π –æ—Ç—á—ë—Ç.";

            const prompt = systemPrompt + "\n\n" + userPrompt;
            const reply = await window.LLMClient.call(prompt, { max_tokens: 1000, temperature: 0.2 });
            out.textContent = reply || summary;
        } catch (e) {
            console.error(e);
            out.textContent = "–û—à–∏–±–∫–∞ WebLLM. –ù–∏–∂–µ —Å–≤–æ–¥–∫–∞:\n\n" + window.App.buildQuarterReportSummary();
        } finally {
            if (btn) btn.disabled = false;
        }
    },

    async generatePedCouncilAgenda() {
        const out = document.getElementById("pedCouncilOut");
        const btn = document.getElementById("btnPedCouncil");
        if (out) out.textContent = "–§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–≤–µ—Å—Ç–∫—É...";
        if (btn) btn.disabled = true;

        try {
            const facts = window.App.buildPedCouncilFacts();

            if (!window.LLMClient?.ready) {
                out.textContent = facts + "\n\n(–ò–ò –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —ç—Ç–æ —Ñ–∞–∫—Ç—ã –¥–ª—è –ø–æ–≤–µ—Å—Ç–∫–∏.)";
                return;
            }

            const systemPrompt =
                "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –ø–µ–¥—Å–æ–≤–µ—Ç–∞. " +
                "–ù–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∫—Ç–æ–≤ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –ø–æ–≤–µ—Å—Ç–∫—É –∑–∞—Å–µ–¥–∞–Ω–∏—è, " +
                "5‚Äì7 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∏ —á–µ—Ä–Ω–æ–≤–∏–∫ —Ä–µ—à–µ–Ω–∏–π/–ø–æ—Ä—É—á–µ–Ω–∏–π (–±–µ–∑ –∏–º—ë–Ω). " +
                "–§–∞–∫—Ç—ã –Ω–µ –º–µ–Ω—è–π –∏ –Ω–µ –¥–æ–±–∞–≤–ª—è–π —Ü–∏—Ñ—Ä.";

            const userPrompt =
                "–§–∞–∫—Ç—ã –¥–ª—è –ø–µ–¥—Å–æ–≤–µ—Ç–∞:\n\n" +
                facts +
                "\n\n–°—Ñ–æ—Ä–º–∏—Ä—É–π:\n" +
                "1) –ü–æ–≤–µ—Å—Ç–∫—É (5‚Äì7 –ø—É–Ω–∫—Ç–æ–≤).\n" +
                "2) –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è.\n" +
                "3) –ü—Ä–æ–µ–∫—Ç —Ä–µ—à–µ–Ω–∏–π –ø–µ–¥—Å–æ–≤–µ—Ç–∞.";

            const prompt = systemPrompt + "\n\n" + userPrompt;
            const reply = await window.LLMClient.call(prompt, { max_tokens: 900, temperature: 0.3 });
            out.textContent = reply || facts;
        } catch (e) {
            console.error(e);
            out.textContent = "–û—à–∏–±–∫–∞ WebLLM. –§–∞–∫—Ç—ã:\n\n" + window.App.buildPedCouncilFacts();
        } finally {
            if (btn) btn.disabled = false;
        }
    }
};

/* ==================== PAGE SWITCH ==================== */
function showPage(id, ev) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (ev && ev.target) ev.target.classList.add('active');
}

/* ==================== STARTUP ==================== */
App.init();
window.addEventListener("load", () => window.LLMClient.init());
</script>

</body>
</html>
