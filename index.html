<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–®–∫–æ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (BI)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Styles -->
    <style>
        :root {
            --primary: #123b71;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text: #333;
            --border: #dde2e5;
            --accent: #3498db;
        }
        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: var(--primary);
            color: #fff;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        header h1 { font-size: 1.2rem; margin: 0; font-weight: 600; }

        .tabs {
            display: flex;
            flex-shrink: 0;
            padding: 0 20px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }
        .tab-link {
            padding: 10px 15px;
            text-decoration: none;
            color: var(--text);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .tab-link:hover {
            background: #f0f0f0;
        }
        .tab-link.active {
            border-bottom-color: var(--accent);
            color: var(--accent);
        }

        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .page {
            display: none;
            min-height: 100%;
        }
        .page.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        .card h3 {
            margin-top: 0;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .kpi-card {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border-left: 5px solid var(--accent);
        }
        .kpi-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .controls label {
            font-weight: 500;
            color: #555;
            white-space: nowrap;
        }
        .controls select, .controls button {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 1rem;
            background: #fff;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .controls button {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        .controls button:hover {
            opacity: 0.9;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .data-table th, .data-table td {
            padding: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .data-table th {
            background-color: #f0f0f0;
            font-weight: 600;
            color: var(--primary);
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .data-table tbody tr:hover {
            background-color: #f0f4f7;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            header, .tabs { padding: 0 10px; }
            header h1 { font-size: 1rem; }
            .tab-link { padding: 10px 8px; font-size: 0.9rem; }
            main { padding: 10px; }
            .card { padding: 15px; }
            .controls { flex-direction: column; align-items: stretch; }
            .controls select, .controls button { width: 100%; }
        }
    </style>
</head>
<body>

    <header>
        <h1>üìä –®–∫–æ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
        <div>
            <!-- The '–ó–∞–≥—Ä—É–∑–∏—Ç—å Excel' button will be injected here by main.js -->
        </div>
    </header>

    <nav class="tabs">
        <a class="tab-link active" data-page="page-overview">–û–±–∑–æ—Ä</a>
        <a class="tab-link" data-page="page-class">–ü–æ –∫–ª–∞—Å—Å–∞–º</a>
        <a class="tab-link" data-page="page-subject">–ü–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</a>
        <a class="tab-link" data-page="page-teacher">–ü–æ —É—á–∏—Ç–µ–ª—è–º</a>
        <a class="tab-link" data-page="page-student">–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å —É—á–µ–Ω–∏–∫–æ–≤</a>
        <a class="tab-link" data-page="page-attendance">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</a>
    </nav>

<main>
    <!-- 1. –û–±–∑–æ—Ä –®–∫–æ–ª—ã -->
    <div id="page-overview" class="page active">
        <div class="controls">
            <label for="overviewTermSelect">–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
            <select id="overviewTermSelect"></select>
            <label for="overviewMetricSelect">–ú–µ—Ç—Ä–∏–∫–∞:</label>
            <select id="overviewMetricSelect">
                <option value="avg_mark">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª (5–±)</option>
                <option value="knowledge_quality">–ö–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π (%)</option>
            </select>
        </div>

        <!-- KPI Summary -->
        <div class="kpi-grid" id="overview-summary">
            <!-- KPIs will be injected here -->
        </div>

        <div class="card">
            <h3>–†–µ–π—Ç–∏–Ω–≥ –∫–ª–∞—Å—Å–æ–≤ –∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h3>
            <div id="chart-overview-table-wrapper">
                <!-- Table will be injected here -->
            </div>
        </div>

        <div class="card" style="display: flex; gap: 20px;">
            <div id="chart-overview-donut" style="flex: 1; min-height: 300px;"></div>
            <div id="chart-overview-ai-wrapper" style="flex: 1; display: flex; flex-direction: column;">
                <h3>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ—Ç AI</h3>
                <p>–ü–æ–ª—É—á–∏—Ç–µ –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>
                <button id="aiInsightBtn" style="margin-bottom: 15px;">üîç –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥</button>
                <div id="aiOutput" class="card" style="flex-grow: 1; background: #f0f7ff; border-left: 5px solid #3498db; margin: 0; font-size: 0.9rem; white-space: pre-wrap; color: #333;">
                    –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞.
                </div>
                <div id="llmProgress" style="margin-top: 10px; font-size: 0.8rem; color: #999;"></div>
            </div>
        </div>
    </div>

    <!-- 2. –ü–æ –∫–ª–∞—Å—Å–∞–º -->
    <div id="page-class" class="page">
        <div class="card">
            <h3>–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ –∫–ª–∞—Å—Å–∞–º</h3>
            <div class="controls">
                <label for="clsTableTermSelect">–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
                <select id="clsTableTermSelect"></select>
                <label for="clsTableMetricSelect">–ú–µ—Ç—Ä–∏–∫–∞:</label>
                <select id="clsTableMetricSelect">
                    <option value="avg_mark">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª (5–±)</option>
                    <option value="knowledge_quality">–ö–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π (%)</option>
                </select>
            </div>
            <div id="class-summary-wrapper">
                <table class="data-table">
                    <thead id="class-summary-header"></thead>
                    <tbody id="class-summary-body">
                        <tr><td colspan="10" style="color: #999;">–í—ã–±–µ—Ä–∏—Ç–µ —á–µ—Ç–≤–µ—Ä—Ç—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ –ø–æ –∫–ª–∞—Å—Å—É</h3>
            <div class="controls">
                <label for="clsDonutTermSelect">–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
                <select id="clsDonutTermSelect"></select>
                <label for="clsDonutClassSelect">–ö–ª–∞—Å—Å:</label>
                <select id="clsDonutClassSelect"></select>
            </div>
            <div id="chart-class-donut" style="min-height: 300px;"></div>
        </div>
    </div>

    <!-- 3. –ü–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º -->
    <div id="page-subject" class="page">
        <div class="controls">
            <label for="subjectTermSelect">–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
            <select id="subjectTermSelect"></select>
            <label for="subjectSubjectSelect">–ü—Ä–µ–¥–º–µ—Ç:</label>
            <select id="subjectSubjectSelect"></select>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª (5–±)</div>
                <div class="kpi-value" id="subKpiAvg"> - </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">–ö–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π (%)</div>
                <div class="kpi-value" id="subKpiKnowledge"> - </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">–û—Ç–ª–∏—á–Ω–∏–∫–æ–≤ (%)</div>
                <div class="kpi-value" id="subKpiExcellent"> - </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">–ù–µ—É—Å–ø–µ–≤–∞—é—â–∏—Ö (2)</div>
                <div class="kpi-value" id="subKpiFailing"> - </div>
            </div>
        </div>

        <div class="card">
            <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫ –ø–æ –∫–ª–∞—Å—Å–∞–º</h3>
            <div id="chart-subject-class" style="min-height: 300px;"></div>
        </div>

        <div class="card">
            <h3>–û–±—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ (0-100)</h3>
            <div id="chart-subject-dist" style="min-height: 300px;"></div>
        </div>

        <div class="card">
            <h3>–î–∏–Ω–∞–º–∏–∫–∞ –æ—Ü–µ–Ω–æ–∫ –ø–æ —á–µ—Ç–≤–µ—Ä—Ç—è–º (—Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª)</h3>
            <div id="chart-subject-trend" style="min-height: 300px;"></div>
        </div>

        <div class="card">
            <h3>–°–≤–æ–¥–Ω–∞—è —Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (–ü—Ä–µ–¥–º–µ—Ç—ã x –ß–µ—Ç–≤–µ—Ä—Ç–∏)</h3>
            <div id="chart-subject-heatmap" style="min-height: 500px;"></div>
        </div>
    </div>

    <!-- 4. –ü–æ —É—á–∏—Ç–µ–ª—è–º -->
    <div id="page-teacher" class="page">
        <div class="controls">
            <label for="teacherTermSelect">–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
            <select id="teacherTermSelect"></select>
            <label for="teacherTeacherSelect">–£—á–∏—Ç–µ–ª—å:</label>
            <select id="teacherTeacherSelect"></select>
        </div>

        <div class="card">
            <h3>–û–±—â–∞—è —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –ø–æ —É—á–∏—Ç–µ–ª—é</h3>
            <div id="chart-teacher-summary" style="min-height: 200px;">
                <!-- KPIs and summary stats injected here -->
            </div>
        </div>

        <div class="card">
            <h3>–†–∞–∑–±–∏–≤–∫–∞ –ø–æ –∫–ª–∞—Å—Å–∞–º –∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º (–ö–∞—á–µ—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π)</h3>
            <div id="chart-teacher-breakdown" style="min-height: 400px;"></div>
        </div>
    </div>

    <!-- 5. –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å —É—á–µ–Ω–∏–∫–æ–≤ -->
    <div id="page-student" class="page">
        <div class="card">
            <h3>–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ —É—á–µ–Ω–∏–∫–æ–≤</h3>
            <div class="controls">
                <label for="stTermSelect">–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
                <select id="stTermSelect"></select>
                <label for="stClassSelect">–ö–ª–∞—Å—Å:</label>
                <select id="stClassSelect"></select>
                <button id="stRefreshBtn">–û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
            </div>
            <div id="stTableWrapper">
                <div style="text-align:center; color:#999; margin-top: 20px;">
                    –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –∏ —á–µ—Ç–≤–µ—Ä—Ç—å, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É".
                </div>
            </div>
        </div>
    </div>

    <!-- 6. –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å -->
    <div id="page-attendance" class="page">
        <div class="card">
            <h3>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</h3>
            <div class="controls">
                <label for="attTermSummary">–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
                <select id="attTermSummary"></select>
            </div>
            <div id="attSummaryTableWrapper">
                <!-- Summary Table will be injected here -->
            </div>
        </div>
        <div class="card">
            <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–ª–∞—Å—Å—É</h3>
            <div class="controls">
                <label for="attTermDetail">–ß–µ—Ç–≤–µ—Ä—Ç—å:</label>
                <select id="attTermDetail"></select>
                <label for="attClassDetail">–ö–ª–∞—Å—Å:</label>
                <select id="attClassDetail"></select>
            </div>
            <div id="attDetailTableWrapper">
                <!-- Detail Table will be injected here -->
            </div>
        </div>
    </div>

</main>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<!-- App Logic -->
<script src="utils.js"></script>
<script src="main.js"></script>
<script src="llm_cpu.js"></script>
<script src="dashboard_overview.js"></script>
<script src="overview.js"></script>
<script src="overview_ai.js"></script>
<script src="attendance.js"></script>
<script src="dashboard_class.js"></script>
<script src="dashboard_subject.js"></script>
<script src="dashboard_teacher.js"></script> <!-- ADDED -->
<script src="dashboard_student.js"></script> <!-- ADDED -->


<script>
    // Tab Switching Logic
    document.addEventListener('DOMContentLoaded', () => {
        const links = document.querySelectorAll('.tab-link');
        const pages = document.querySelectorAll('.page');

        function activatePage(pageId) {
            pages.forEach(p => p.classList.remove('active'));
            links.forEach(l => l.classList.remove('active'));
            
            const activePage = document.getElementById(pageId);
            const activeLink = document.querySelector(`.tab-link[data-page="${pageId}"]`);
            
            if (activePage) activePage.classList.add('active');
            if (activeLink) activeLink.classList.add('active');
            
            // Trigger specific dashboard updates on tab change if needed
            if (pageId === 'page-teacher' && window.SBI_Teacher) {
                window.SBI_Teacher.update();
            } else if (pageId === 'page-student' && window.SBI_Students) {
                // Ensure student filters are populated and table rendered
                window.SBI_Students.populate();
                window.SBI_Students.render(); 
            } else if (pageId === 'page-attendance' && window.SBI_Attendance) {
                // Ensure attendance data is rendered
                window.SBI_Attendance.renderSummary();
                window.SBI_Attendance.renderDetail();
            }
        }

        links.forEach(link => {
            link.addEventListener('click', () => {
                const pageId = link.getAttribute('data-page');
                activatePage(pageId);
            });
        });

        // Initialize components that rely on DOM
        if (window.SBI_Students) window.SBI_Students.init();
        if (window.SBI_Teacher) window.SBI_Teacher.init();
        if (window.SBI_Attendance) window.SBI_Attendance.init();
        if (window.SBI_Class) window.SBI_Class.init();
        if (window.SBI_Overview) window.SBI_Overview.init(); 

        // Initial active page
        activatePage('page-overview');
    });
</script>

</body>
</html>
